image: registry.gitlab.com/app4business/docker-images/meteor:6078dd1204091ec11611661f9311a8c3b64a435e

stages:
  - build

variables:
  TOOL_NODE_FLAGS: --max-old-space-size=4096
  HOME: $PWD/../

cache:
  paths:
  - "$HOME/node_modules"
  - "$HOME/.meteor"
  - "$HOME/.npm"
  - "$HOME/.node-gyp"
  - "$HOME/build/RocketChat/Rocket.Chat/node_modules"
  - "$HOME/build/RocketChat/Rocket.Chat/.meteor/local"
  - "$HOME/build/RocketChat/Rocket.Chat/packages/rocketchat-livechat/.npm"
  - "$HOME/build/RocketChat/Rocket.Chat/packages/rocketchat-livechat/.app/node_modules"
  - "$HOME/build/RocketChat/Rocket.Chat/packages/rocketchat-livechat/.app/.meteor/local"


build:
  stage: build
  artifacts:
    name: build
    paths:
    - "$HOME/build"
  script:
    - echo "$HOME"
    - &install if [ ! -e "$HOME/.meteor/meteor" ]; then curl https://install.meteor.com | sed s/--progress-bar/-sL/g | /bin/sh; fi
    - export PATH="$HOME/.meteor:$PATH"
    - meteor npm install
    - meteor build --server-only $HOME/build
    - rm -rf $HOME/build/RocketChat/Rocket.Chat/.meteor/local/log
    - rm -rf $HOME/build/RocketChat/Rocket.Chat/.meteor/local/run
    - rm -rf $HOME/build/RocketChat/Rocket.Chat/.meteor/local/db

